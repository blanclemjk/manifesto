name: Deploy Hugo Site to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: "0.120.4"
          extended: true

      - name: Copy Vault Content
        run: |
          # Create destination directory for Vault M
          mkdir -p hugo/content/M

          # Copy contents of M to hugo/content/M
          # We use -r to copy recursively
          if [ -d "M" ]; then
            cp -r M/* hugo/content/M/
            echo "Copied M vault content"
          else
            echo "Warning: Directory M not found"
          fi

          # Placeholder for second vault (Uncomment and update name when ready)
          # mkdir -p hugo/content/Vault2
          # if [ -d "Vault2" ]; then
          #   cp -r Vault2/* hugo/content/Vault2/
          # fi

      - name: Ensure Front Matter
        run: |
          find hugo/content -name "*.md" | while read file; do
            if ! head -n 1 "$file" | grep -q "^---$"; then
              filename=$(basename "$file" .md)
              echo "Adding front matter to $file"
              # Create temp file with front matter
              echo "---" > "${file}.tmp"
              echo "title: \"$filename\"" >> "${file}.tmp"
              echo "---" >> "${file}.tmp"
              cat "$file" >> "${file}.tmp"
              mv "${file}.tmp" "$file"
            fi
          done

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Generate Indices (hugo-obsidian)
        run: |
          cd hugo
          mkdir -p assets/indices
          go install github.com/jackyzha0/hugo-obsidian@latest
          export PATH=$PATH:$(go env GOPATH)/bin
          hugo-obsidian -input=content -output=assets/indices -index -root=.

      - name: Build
        run: |
          cd hugo
          hugo --minify

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./hugo/public

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
