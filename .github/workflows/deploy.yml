name: Deploy Hugo Site to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: "0.120.4"
          extended: true

      - name: Copy Vault Content
        run: |
          # Clean existing content to remove theme defaults
          rm -rf hugo/content
          mkdir -p hugo/content

          # Create root _index.md to redirect or list vaults
          echo "---" > hugo/content/_index.md
          echo "title: Home" >> hugo/content/_index.md
          echo "---" >> hugo/content/_index.md
          echo "# Welcome" >> hugo/content/_index.md
          echo "" >> hugo/content/_index.md
          echo "Select a vault to browse:" >> hugo/content/_index.md
          echo "" >> hugo/content/_index.md
          echo "- [M](M/)" >> hugo/content/_index.md
          echo "- [W](W/)" >> hugo/content/_index.md

          # Create destination directory for Vault M
          mkdir -p hugo/content/M

          # Create _index.md for M to ensure it's treated as a section
          echo "---" > hugo/content/M/_index.md
          echo "title: M" >> hugo/content/M/_index.md
          echo "---" >> hugo/content/M/_index.md

          # Copy contents of M to hugo/content/M
          # We use -r to copy recursively
          if [ -d "M" ]; then
            cp -r M/* hugo/content/M/
            echo "Copied M vault content"
          else
            echo "Warning: Directory M not found"
          fi

          # Create destination directory for Vault W
          mkdir -p hugo/content/W

          # Create _index.md for W to ensure it's treated as a section
          echo "---" > hugo/content/W/_index.md
          echo "title: W" >> hugo/content/W/_index.md
          echo "---" >> hugo/content/W/_index.md

          # Copy contents of W to hugo/content/W
          if [ -d "W" ]; then
            cp -r W/* hugo/content/W/
            echo "Copied W vault content"
          else
             echo "Warning: Directory W not found"
          fi

          # Remove theme content to prevent it from showing up
          rm -rf hugo/themes/amethyst/content

          # Debug: List content directory
          ls -R hugo/content

      - name: Ensure Front Matter
        run: |
          find hugo/content -name "*.md" | while read file; do
            if ! head -n 1 "$file" | grep -q "^---$"; then
              filename=$(basename "$file" .md)
              echo "Adding front matter to $file"
              # Create temp file with front matter
              echo "---" > "${file}.tmp"
              echo "title: \"$filename\"" >> "${file}.tmp"
              echo "---" >> "${file}.tmp"
              cat "$file" >> "${file}.tmp"
              mv "${file}.tmp" "$file"
            fi
          done

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Generate Indices (hugo-obsidian)
        run: |
          cd hugo
          mkdir -p assets/indices
          mkdir -p static
          go install github.com/jackyzha0/hugo-obsidian@latest
          export PATH=$PATH:$(go env GOPATH)/bin
          hugo-obsidian -input=content -output=assets/indices -index -root=.

      - name: Build
        run: |
          cd hugo
          hugo --minify

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./hugo/public

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
